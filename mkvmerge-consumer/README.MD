                    MKV MEDIA AUTOMATION SYSTEM
                    ============================

┌─────────────────┐    ┌───────────────────────────────────────────────────┐
│   External      │    │                RabbitMQ Server                    │
│   Message       │───▶│                x.x.x.x:5672                       │
│   Producer      │    │         vhost: media-automation                   │
└─────────────────┘    └───────────────────────────────────────────────────┘
                                              │
                                              ▼
         ┌────────────────────────────────────────────────────────────────────┐
         │                        QUEUE SYSTEM                                │
         │                                                                    │
         │ ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐  │
         │ │ mkvmerge.tasks  │    │  mkvmerge.done  │    │ Dead Letter     │  │
         │ │ (Input Queue)   │    │ (Output Queue)  │    │ Queues (DLQs)   │  │
         │ │                 │    │                 │    │                 │  │
         │ │ Messages:       │    │ Messages:       │    │ Failed messages │  │
         │ │ {               │    │ {               │    │ with error info │  │
         │ │   torrentName,  │    │   filename,     │    │                 │  │
         │ │   category      │    │   status,       │    │                 │  │
         │ │ }               │    │   time          │    │                 │  │
         │ └─────────────────┘    │ }               │    │                 │  │
         │                        └─────────────────┘    └─────────────────┘  │
         └────────────────────────────────────────────────────────────────────┘
                    │                              │
                    ▼                              ▼
    
    ┌─────────────────────────────────┐    ┌─────────────────────────────────┐
    │        MKV CONSUMER             │    │        MKV NOTIFIER             │
    │     (mkvmerge-consumer)         │    │     (mkvmerge-notifier)         │
    │                                 │    │                                 │
    │ Consumes: mkvmerge.tasks        │    │ Consumes: mkvmerge.done         │
    │                                 │    │                                 │
    │ PROCESSING FLOW:                │    │ NOTIFICATION FLOW:              │
    │ ┌─────────────────────────────┐ │    │ ┌─────────────────────────────┐ │
    │ │ 1. Receive message          │ │    │ │ 1. Receive completion msg   │ │
    │ │ 2. Parse JSON               │ │    │ │ 2. Parse JSON               │ │
    │ │ 3. Map category to path     │ │    │ │ 3. Format notification      │ │
    │ │ 4. Find folder              │ │    │ │ 4. Send to Telegram         │ │
    │ │ 5. Locate .mkv files        │ │    │ │ 5. Acknowledge message      │ │
    │ │ 6. For each .mkv:           │ │    │ └─────────────────────────────┘ │
    │ │    ├─ Get track info        │ │    │                                 │
    │ │    ├─ Check languages       │ │    │ ERROR HANDLING:                 │
    │ │    ├─ Filter tracks         │ │    │ • JSON parsing errors → DLQ     │
    │ │    ├─ Run mkvmerge          │ │    │ • Missing fields → DLQ          │
    │ │    └─ Replace original      │ │    │ • Telegram failures → DLQ       │
    │ │ 7. Publish to done queue    │ │    │                                 │
    │ │ 8. Acknowledge message      │ │    │ TELEGRAM OUTPUT:                │
    │ └─────────────────────────────┘ │    │ 🎬 MKV Processing Complete      │
    │                                 │    │ 📁 File: filename.mkv           │
    │ TRACK FILTERING:                │    │ ✅ Status: processed            │
    │ • Keep all video tracks         │    │ 🕒 Completed: timestamp         │
    │ • Keep English audio only       │    │ 📂 Full Path: /path/to/file     │
    │ • Keep English subtitles        │    │                                 │
    │ • If no ENG audio, keep all     │    │                                 │
    │                                 │    │                                 │
    │ CATEGORY MAPPINGS:              │    │                                 │
    │ • local-movies  → /mnt/vault/   │    │                                 │
    │ • local-tvshows → media/jello/  │    │                                 │
    │ • nas-tvshows   → /mnt/vault-   │    │                                 │
    │ • nas-movies    → media/        │    │                                 │
    │                                 │    │                                 │
    │ ERROR HANDLING:                 │    │                                 │
    │ • JSON parsing errors → DLQ     │    │                                 │
    │ • Unknown categories → DLQ      │    │                                 │
    │ • Missing folders → DLQ         │    │                                 │
    │ • No successful processing →    │    │                                 │
    │   message stays in queue        │    │                                 │
    └─────────────────────────────────┘    └─────────────────────────────────┘
                    │                                              │
                    ▼                                              ▼
    ┌─────────────────────────────────┐                          ┌─────────────────┐
    │        FILE SYSTEM              │                          │   TELEGRAM      │
    │                                 │                          │     BOT         │
    │ Media Storage Paths:            │                          │                 │
    │ • /mnt/vault/media/jello/       │                          │ Sends formatted │
    │ • /mnt/vault-media/             │                          │ notifications   │
    │                                 │                          │ to configured   │
    │ Operations:                     │                          │ chat/user       │
    │ • Scan for .mkv files           │                          │                 │
    │ • Analyze track information     │                          │                 │
    │ • Create temporary files        │                          │                 │
    │ • Replace originals             │                          │                 │
    │ • Preserve directory structure  │                          │                 │
    └─────────────────────────────────┘                          └─────────────────┘

                              SYSTEM FEATURES
                              ===============
    • Dead Letter Queue (DLQ) support for failed messages
    • Graceful shutdown handling (SIGINT/SIGTERM)
    • Message persistence and durability
    • QoS settings for controlled processing
    • Comprehensive error logging