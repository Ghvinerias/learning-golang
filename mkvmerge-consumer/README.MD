                    MKV MEDIA AUTOMATION SYSTEM
                    ============================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   External      â”‚    â”‚                RabbitMQ Server                    â”‚
â”‚   Message       â”‚â”€â”€â”€â–¶â”‚                x.x.x.x:5672                       â”‚
â”‚   Producer      â”‚    â”‚         vhost: vhost-media-automation             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                        QUEUE SYSTEM                                â”‚
         â”‚                                                                    â”‚
         â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
         â”‚ â”‚ mkvmerge.tasks  â”‚    â”‚  mkvmerge.done  â”‚    â”‚ Dead Letter     â”‚  â”‚
         â”‚ â”‚ (Input Queue)   â”‚    â”‚ (Output Queue)  â”‚    â”‚ Queues (DLQs)   â”‚  â”‚
         â”‚ â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚  â”‚
         â”‚ â”‚ Messages:       â”‚    â”‚ Messages:       â”‚    â”‚ Failed messages â”‚  â”‚
         â”‚ â”‚ {               â”‚    â”‚ {               â”‚    â”‚ with error info â”‚  â”‚
         â”‚ â”‚   torrentName,  â”‚    â”‚   filename,     â”‚    â”‚                 â”‚  â”‚
         â”‚ â”‚   category      â”‚    â”‚   status,       â”‚    â”‚                 â”‚  â”‚
         â”‚ â”‚ }               â”‚    â”‚   time          â”‚    â”‚                 â”‚  â”‚
         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ }               â”‚    â”‚                 â”‚  â”‚
         â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                              â”‚
                    â–¼                              â–¼
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚        MKV CONSUMER             â”‚    â”‚        MKV NOTIFIER             â”‚
    â”‚     (mkvmerge-consumer)         â”‚    â”‚     (mkvmerge-notifier)         â”‚
    â”‚                                 â”‚    â”‚                                 â”‚
    â”‚ Consumes: mkvmerge.tasks        â”‚    â”‚ Consumes: mkvmerge.done         â”‚
    â”‚                                 â”‚    â”‚                                 â”‚
    â”‚ PROCESSING FLOW:                â”‚    â”‚ NOTIFICATION FLOW:              â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ â”‚ 1. Receive message          â”‚ â”‚    â”‚ â”‚ 1. Receive completion msg   â”‚ â”‚
    â”‚ â”‚ 2. Parse JSON               â”‚ â”‚    â”‚ â”‚ 2. Parse JSON               â”‚ â”‚
    â”‚ â”‚ 3. Map category to path     â”‚ â”‚    â”‚ â”‚ 3. Format notification      â”‚ â”‚
    â”‚ â”‚ 4. Find folder              â”‚ â”‚    â”‚ â”‚ 4. Send to Telegram         â”‚ â”‚
    â”‚ â”‚ 5. Locate .mkv files        â”‚ â”‚    â”‚ â”‚ 5. Acknowledge message      â”‚ â”‚
    â”‚ â”‚ 6. For each .mkv:           â”‚ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚ â”‚    â”œâ”€ Get track info        â”‚ â”‚    â”‚                                 â”‚
    â”‚ â”‚    â”œâ”€ Check languages       â”‚ â”‚    â”‚ ERROR HANDLING:                 â”‚
    â”‚ â”‚    â”œâ”€ Filter tracks         â”‚ â”‚    â”‚ â€¢ JSON parsing errors â†’ DLQ     â”‚
    â”‚ â”‚    â”œâ”€ Run mkvmerge          â”‚ â”‚    â”‚ â€¢ Missing fields â†’ DLQ          â”‚
    â”‚ â”‚    â””â”€ Replace original      â”‚ â”‚    â”‚ â€¢ Telegram failures â†’ DLQ       â”‚
    â”‚ â”‚ 7. Publish to done queue    â”‚ â”‚    â”‚                                 â”‚
    â”‚ â”‚ 8. Acknowledge message      â”‚ â”‚    â”‚ TELEGRAM OUTPUT:                â”‚
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ ğŸ¬ MKV Processing Complete      â”‚
    â”‚                                 â”‚    â”‚ ğŸ“ File: filename.mkv           â”‚
    â”‚ TRACK FILTERING:                â”‚    â”‚ âœ… Status: processed            â”‚
    â”‚ â€¢ Keep all video tracks         â”‚    â”‚ ğŸ•’ Completed: timestamp         â”‚
    â”‚ â€¢ Keep English audio only       â”‚    â”‚ ğŸ“‚ Full Path: /path/to/file     â”‚
    â”‚ â€¢ Keep English subtitles        â”‚    â”‚                                 â”‚
    â”‚ â€¢ If no ENG audio, keep all     â”‚    â”‚                                 â”‚
    â”‚                                 â”‚    â”‚                                 â”‚
    â”‚ CATEGORY MAPPINGS:              â”‚    â”‚                                 â”‚
    â”‚ â€¢ local-movies  â†’ /mnt/vault/   â”‚    â”‚                                 â”‚
    â”‚ â€¢ local-tvshows â†’ media/jello/  â”‚    â”‚                                 â”‚    â”‚                                 â”‚    â”‚                                 â”‚
    â”‚ ERROR HANDLING:                 â”‚    â”‚                                 â”‚
    â”‚ â€¢ JSON parsing errors â†’ DLQ     â”‚    â”‚                                 â”‚
    â”‚ â€¢ Unknown categories â†’ DLQ      â”‚    â”‚                                 â”‚
    â”‚ â€¢ Missing folders â†’ DLQ         â”‚    â”‚                                 â”‚
    â”‚ â€¢ No successful processing â†’    â”‚    â”‚                                 â”‚
    â”‚   message stays in queue        â”‚    â”‚                                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                                              â”‚
                    â–¼                                              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚        FILE SYSTEM              â”‚                          â”‚   TELEGRAM      â”‚
    â”‚                                 â”‚                          â”‚     BOT         â”‚
    â”‚ Media Storage Paths:            â”‚                          â”‚                 â”‚
    â”‚ â€¢ /mnt/vault/media/jello/       â”‚                          â”‚ Sends formatted â”‚
    â”‚ â€¢ /mnt/vault-media/             â”‚                          â”‚ notifications   â”‚
    â”‚                                 â”‚                          â”‚ to configured   â”‚
    â”‚ Operations:                     â”‚                          â”‚ chat/user       â”‚
    â”‚ â€¢ Scan for .mkv files           â”‚                          â”‚                 â”‚
    â”‚ â€¢ Analyze track information     â”‚                          â”‚                 â”‚
    â”‚ â€¢ Create temporary files        â”‚                          â”‚                 â”‚
    â”‚ â€¢ Replace originals             â”‚                          â”‚                 â”‚
    â”‚ â€¢ Preserve directory structure  â”‚                          â”‚                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              SYSTEM FEATURES
                              ===============
    â€¢ Configuration via godotenv and viper (environment variables and config files)
    â€¢ Dead Letter Queue (DLQ) support for failed messages
    â€¢ Graceful shutdown handling (SIGINT/SIGTERM)
    â€¢ Message persistence and durability
    â€¢ QoS settings for controlled processing
    â€¢ Comprehensive error logging

## Configuration

This service uses a combination of config files (YAML) and environment variables for configuration:

### Configuration Methods (in order of precedence)

1. **Environment Variables**: Highest precedence
2. **`.env` File**: Loaded at startup if present
3. **Configuration Files**: `config.yaml` in the following locations:
   - Current directory (`./config.yaml`)
   - Config directory (`./config/config.yaml`)
   - System config directory (`/etc/mkvmerge-consumer/config.yaml`)
4. **Default Values**: Used when no other configuration is provided

### RabbitMQ Configuration

```yaml
# config.yaml
rabbitmq:
  host: "10.10.40.19"
  port: "5672"
  username: "mkvmerge-consumer"
  password: "mkvmerge-consumer"
  vhost: "media-automation"
  queue:
    tasks: "mkvmerge.tasks"
    done: "mkvmerge.done"
    dlq: "mkvmerge.tasks_DLQ"
```

**Corresponding Environment Variables:**
```
RABBITMQ_HOST=10.10.40.19
RABBITMQ_PORT=5672
RABBITMQ_USERNAME=mkvmerge-consumer
RABBITMQ_PASSWORD=mkvmerge-consumer
RABBITMQ_VHOST=media-automation
RABBITMQ_QUEUE_TASKS=mkvmerge.tasks
RABBITMQ_QUEUE_DONE=mkvmerge.done
RABBITMQ_QUEUE_DLQ=mkvmerge.tasks_DLQ
```

### File Path Configuration

```yaml
# config.yaml
paths:
  categories:
    local-movies: "/mnt/vault/media/jello/movies"
    local-tvshows: "/mnt/vault/media/jello/tvshows"
```

**Corresponding Environment Variable:**
```
# JSON string format
PATHS_CATEGORIES='{"local-movies":"/mnt/vault/media/jello/movies","local-tvshows":"/mnt/vault/media/jello/tvshows"}'
```

## Docker Usage

### Docker Compose

The easiest way to run this service is using Docker Compose:

```bash
# Start the service
docker-compose up -d

# View logs
docker-compose logs -f

# Stop the service
docker-compose down
```

### Manual Docker Build and Run

```bash
# Build the Docker image
docker build -t mkvmerge-consumer .

# Run the container
docker run -d \
  --name mkvmerge-consumer \
  -v /mnt/vault/media:/mnt/vault/media:rw \
  -v $(pwd)/config:/app/config:ro \
  -e RABBITMQ_HOST=10.10.40.19 \
  mkvmerge-consumer
```